heat_template_version: 2014-10-16

parameters:
  flavor:
    type: string
    default: bmc

  image:
    type: string
    default: openstack-bmc

  key_name:
    type: string
    default: bnemec

  bmc_prefix:
    type: string
    default: bmc

  baremetal_prefix:
    type: string
    default: bmc

  private_net:
    type: string

  provision_net:
    type: string

  suffix:
    type: string

resources:
    OpenStackBMCServer:
        type: OS::Nova::Server
        properties:
            flavor: {get_param: flavor}
            image: {get_param: image}
            key_name: {get_param: key_name}
            networks:
                - network: {get_param: private_net}
            user_data_format: SOFTWARE_CONFIG
            name:
                list_join:
                    - ''
                    - - {get_param: bmc_prefix}
                      - {get_param: suffix}

    BaremetalFlavor:
        type: OS::Nova::Flavor
        properties:
            disk: 50
            extra_specs: {"libvirt:pxe-first": 1}
            ram: 4096
            vcpus: 2

    OpenStackBaremetalServer:
        type: OS::Nova::Server
        properties:
            flavor: {get_resource: BaremetalFlavor}
            image: empty
            config_drive: false
            key_name: {get_param: key_name}
            networks:
                - network: {get_param: provision_net}
                - network: {get_param: private_net}
            name:
                list_join:
                    - ''
                    - - {get_param: baremetal_prefix}
                      - {get_param: suffix}

    ServerConfig:
        type: OS::Heat::StructuredConfig
        properties:
            group: os-apply-config
            config:
                bmc:
                    instance: {get_input: instance}

    ServerDeployment:
        type: OS::Heat::StructuredDeployment
        properties:
            config: {get_resource: ServerConfig}
            server: {get_resource: OpenStackBMCServer}
            signal_transport: NO_SIGNAL
            input_values:
                instance:
                    list_join:
                    - ''
                    - - {get_param: baremetal_prefix}
                      - {get_param: suffix}